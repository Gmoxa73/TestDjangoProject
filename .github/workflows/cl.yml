name: Testing and deployment

on:
  push:
    branches: [master]

jobs:
  testing:
    runs-on: ubuntu-latest
    services:
      postgresql_main:
        image: postgres:14
        env:
          POSTGRES_DB: ${{ secrets.DJANGO_DB_NAME }}
          POSTGRES_USER: ${{ secrets.DJANGO_DB_USER }}
          POSTGRES_PASSWORD: ${{ secrets.DJANGO_DB_PASSWORD }}
        ports:
          - 5432:5432
        options:
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.12

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Wait for PostgreSQL to be ready
        run: |
          for i in {1..10}; do
            pg_isready -h localhost -p 5432 -U ${{ secrets.DJANGO_DB_USER }} && break
            echo "PostgreSQL is not ready, waiting..."
            sleep 5
          done

      - name: Apply migrations
        env:
          DJANGO_SECRET_KEY: ${{ secrets.SECRET }}
          DJANGO_DEBUG: ${{ secrets.DEBUG_MODE }}
          DJANGO_ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
          DJANGO_DB: ${{ secrets.DJANGO_DB }}
          DJANGO_DB_NAME: ${{ secrets.DJANGO_DB_NAME }}
          DJANGO_DB_USER: ${{ secrets.DJANGO_DB_USER }}
          DJANGO_DB_PASSWORD: ${{ secrets.DJANGO_DB_PASSWORD }}
          DJANGO_DB_HOST: localhost  # Важно: используем localhost для сервиса
          DJANGO_DB_PORT: 5432
        run: |
          python manage.py makemigrations --check || echo "No changes detected"
          python manage.py migrate

      - name: Check auth_user table exists
        run: |
          python manage.py shell --command="
          from django.db import connection;
          with connection.cursor() as cursor:
              cursor.execute(\"\"\"
                  SELECT 1 FROM pg_tables
                  WHERE tablename = 'auth_user' AND schemaname = 'public';
              \"\"\");
              if cursor.fetchone():
                  print('OK: Таблица auth_user найдена')
              else:
                  raise SystemExit('ERROR: Таблица auth_user отсутствует!')
          "
        env:
          DJANGO_SECRET_KEY: ${{ secrets.SECRET }}
          DJANGO_DEBUG: ${{ secrets.DEBUG_MODE }}
          DJANGO_ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
          DJANGO_DB: ${{ secrets.DJANGO_DB }}
          DJANGO_DB_NAME: ${{ secrets.DJANGO_DB_NAME }}
          DJANGO_DB_USER: ${{ secrets.DJANGO_DB_USER }}
          DJANGO_DB_PASSWORD: ${{ secrets.DJANGO_DB_PASSWORD }}
          DJANGO_DB_HOST: localhost  # Важно: используем localhost для сервиса
          DJANGO_DB_PORT: 5432

      - name: Run tests
        env:
          DJANGO_SECRET_KEY: ${{ secrets.SECRET }}
          DJANGO_DEBUG: ${{ secrets.DEBUG_MODE }}
          DJANGO_ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
          DJANGO_DB: ${{ secrets.DJANGO_DB }}
          DJANGO_DB_NAME: ${{ secrets.DJANGO_DB_NAME }}
          DJANGO_DB_USER: ${{ secrets.DJANGO_DB_USER }}
          DJANGO_DB_PASSWORD: ${{ secrets.DJANGO_DB_PASSWORD }}
          DJANGO_DB_HOST: localhost
          DJANGO_DB_PORT: 5432
        run: python manage.py test

      - name: Linting
        run: flake8 --exclude=aa